<html>
<head>
	<script src="https://code.jquery.com/jquery-3.6.3.min.js" integrity3="sha256-pvPw+upLPUjgMXY0G+8O0xUf+/Im1MZjXxxgOcBQBXU=" crossorigin="anonymous"></script>
	<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js" integrity="sha256-lSjKY0/srUM9BE3dPm+c4fBo1dky2v27Gdjm2uoZaL0=" crossorigin="anonymous"></script>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
	<link href='https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/ui-lightness/jquery-ui.css' rel='stylesheet'>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css">
	 
	<script>
	var code="ea32b02c65e4fb51415063b77168f1c611137b77b5f445f6d85ac2a00834e893"
	var rooms = ajax("https://api.planningcenteronline.com/calendar/v2/resources?filter=rooms&order=name");
	var t_n;
	var return_code;
		
	$(function(){ 
		const queryString = window.location.search;
		const urlParams = new URLSearchParams(queryString);
		return_code = urlParams.get('code');
		
		if (!t_n && !return_code)
		{
			window.location="https://api.planningcenteronline.com/oauth/authorize?client_id=4d16b452f211191a3a92d5f8579caef561dfd759148f1f096921c845ec97337d&redirect_uri=https://rusyus2000.github.io&response_type=code&scope=calendar";
		}
		if(!t_n)
		{
			app_authenticate();
		}
		else
		{
			var daySchedule = ajax("https://api.planningcenteronline.com/calendar/v2/resource_bookings?where[starts_at]="+date+"&where[ends_at]="+date)
			//var multidayEvents = ajax("https://api.planningcenteronline.com/calendar/v2/resource_bookings?where[ends_at][gte]="+date+"&where[starts_at][lte]="+date)
			generateCalendar(rooms, daySchedule);
		}


		
		var date = new Date().toLocaleDateString('en-CA');
	
		$( "#datepicker" ).datepicker({
			dateFormat: 'yy-mm-dd, DD',
		})
		.on("change",function(){
			RefreshCalendar();
		})
		
		$("#datepicker").datepicker( "setDate" , new Date());
	});
	
	function RefreshCalendar()
	{
		var dateStr = $("#datepicker").val()
		var dateOnly = dateStr.substring(0, dateStr.indexOf(","));
		var daySchedule = ajax("https://api.planningcenteronline.com/calendar/v2/resource_bookings?where[starts_at]="+dateOnly+"&where[ends_at]="+dateOnly)
		generateCalendar(rooms, daySchedule);
	}
	
	function ajax(url){
		var returnVal;
		$.ajax
			({
			  type: "GET",
			  url: url,
			  dataType: 'json',
			  async: false,
			  data: '{ "comment" }',
			  beforeSend: function(xhr) { 
				xhr.setRequestHeader("Authorization", "Bearer " + t_n); 
				},
			  success: function (data){
				returnVal =	data; 
			  },
			  error: function(response){
				alert(response);
			  }
			});
			return returnVal;
	}
	
	function user_authenticate(){
		$.ajax
			({
			  type: "POST",
			  url: "https://api.planningcenteronline.com/oauth/authorize?client_id=4d16b452f211191a3a92d5f8579caef561dfd759148f1f096921c845ec97337d&redirect_uri=https://rusyus2000.github.io&response_type=code&scope=calendar",
			  async: false,
			  success: function (data){
				returnVal = data; 
			  },
			  error: function(response){
				alert(response);
			  }
			});
			return returnVal;
	}
	
	function app_authenticate(){
		var _url = "https://api.planningcenteronline.com/oauth/token?grant_type=authorization_code&code="+return_code+"&client_id=4d16b452f211191a3a92d5f8579caef561dfd759148f1f096921c845ec97337d&client_secret="+code+"&redirect_uri=https://rusyus2000.github.io";
		$.ajax
			({
			  type: "POST",
			  url: _url,
			  async: false,
			  success: function (data){
				alert(data.access_token);
				t_n=data.access_token; 
			  },
			  error: function(response){
				alert(response);
			  }
			});
	}
	
	
	function generateCalendar(roomsObj, scheduleObj)
	{
		$("#divMain").empty();
		
		jQuery('<table >',{
			id: "tblCalendar",
			style: "margin:auto"
		}).appendTo("#divMain");
		
		//first row
		var th = jQuery('<tr>');
		th.appendTo("#tblCalendar");
		for (let i=6; i<=22; i++)
		{
			if (i==6){
					var blanktd = jQuery('<td>');
					blanktd.appendTo(th);
			}
			else
			{
				var timetd = jQuery('<td class="fw-bold">');
				timetd.append('&nbsp;'+(i<=12?i:i-12)+(i<12?"am":"pm")+'&nbsp;');
				timetd.appendTo(th);
			}
		
		}
		
		//this loop creates layout
		$.each(roomsObj.data, function(j){
		
			//add separators
			if (roomsObj.data[j].id == 464259 
				|| roomsObj.data[j].id == 464821
				|| roomsObj.data[j].id == 464240)
			{
				var tr = jQuery('<tr id="trSeparator'+roomsObj.data[j].id+'" style="background-color:#ddd">');
				tr.appendTo("#tblCalendar");	
				var td=jQuery('<td>',{colspan:'17',style:'border:1px solid #ccc'});
				td.appendTo(tr);
			}
			
			var tr = jQuery('<tr id="tr'+roomsObj.data[j].id+'" onMouseOver="$(this).css(\'background-color\',\'#e9f2f2\')" onMouseOut="$(this).css(\'background-color\',\'#FFF\')">');
			tr.appendTo("#tblCalendar");
			
			
		
			for (let i=6; i<=22; i++)
			{
				if (i==6){
					var td = jQuery('<td class="fw-bold">');
					td.append(roomsObj.data[j].attributes.name);
					td.appendTo(tr);
				}
				else{
					var td = jQuery('<td>',{
						style:'border:1px solid #ccc',
						id:i+'-'+roomsObj.data[j].id
						});
					td.appendTo(tr);
				}
			}
		})
		
			
		//this loop goes through all scheduled resources for given date
		$.each(scheduleObj.data,function(i){
			var startTime = new Date(scheduleObj.data[i].attributes.starts_at).toLocaleString('en-US', {timeZone: 'America/Los_Angeles'});
			var startTimeHours = new Date(startTime).getHours();			
			var endTime = new Date(scheduleObj.data[i].attributes.ends_at).toLocaleString('en-US', {timeZone: 'America/Los_Angeles'});
			var endTimeHours = new Date(endTime).getHours();
			var endTimeMinutes = new Date(endTime).getMinutes();
										
			//this loop marks needed cells as not available
			for (let t=startTimeHours;t<=endTimeHours;t++)
			{	
				var tdId = '#'+ t + '-' + scheduleObj.data[i].relationships.resource.data.id;
				
				if (t==endTimeHours){
					if (endTimeMinutes != 0)
						$(tdId).css("background-color","pink");
				}
				else
					$(tdId).css("background-color","pink");
			}
			
		});
	}
	
	function SetDate(dayIncrement)
	{
		var dateStr = $("#datepicker").val()
		var dateOnly = dateStr.substring(0, dateStr.indexOf(","));
		$("#datepicker").datepicker( "setDate" , addDays(dateOnly,dayIncrement));
		RefreshCalendar();
	}
	function addDays(date, days) {
	  var result = new Date(date);
	  result.setTime(result.getTime() + 8*60*60*1000); //add 8 hours to compensate fot PST
	  result.setDate(result.getDate() + days);
	  return result;
}
	</script>
</head>
<body>

<div class="container">

	<div class="text-center"><img src="https://www.brytechurch.org/wp-content/uploads/2018/11/cropped-LOGO-cropped.png" class="text-center" style="max-width:50%"/></div>
	<h3 class="text-center p-3">Room Availability</h3>
	<div class="card border-info">
		<div class="card-header text-center pt-3 pb-3" style="font-size:1.5em;font-style:bold">
			Date: 
			<a href="#" onclick="SetDate(-1);return false;" style="text-decoration:none;position:relative;top:3px">&nbsp;<i class="fa-solid fa-chevron-left"></i>&nbsp;</a> 
			<input class="form-control w-25" style="display:inline-block" type="text" id="datepicker"/>
			<a href="#" onclick="SetDate(1);return false;" style="text-decoration:none;position:relative;top:3px">&nbsp;<i class="fa-solid fa-chevron-right"></i></a> 
		</div>
		<div class="card-body">
			
			<div id="divMain" class="text-center">
			</div>
		</div>
	</div>
	
</div>

</body>
</html>
